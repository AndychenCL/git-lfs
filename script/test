#!/usr/bin/env bash
#/ Usage: script/test          # run all non-vendored tests
#/        script/test <subdir> # run just a package's tests

script/fmt

# Only set GOPATH on non-Windows platforms as Windows can't do the symlinking
# that we need.
if [ -z "$GOPATH" ] && uname -s | grep -vq "_NT-"; then
  export GOPATH="$(pwd)"
  mkdir -p src/github.com/github
  [ -h src/github.com/github/git-lfs ] ||
    ln -s "$GOPATH" src/github.com/github/git-lfs
fi

if [ $# -gt 0 ]; then
    GO15VENDOREXPERIMENT=1 go test "./$1"
else
    GO15VENDOREXPERIMENT=1 go test \
      $(GO15VENDOREXPERIMENT=1 go list ./... \
          | grep -v "github.com/olekukonko/ts" \
          | grep -v "github.com/technoweenie/go-contentaddressable" \
      )
fi
